name: Commitlint

on:
    pull_request:
        types: [opened, synchronize, reopened]
    push:
        branches: [develop]

jobs:
    commitlint:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Fetch all history for commit analysis

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Validate commits
              run: |
                  # For PRs, check all commits in the PR
                  if [[ "${{ github.event_name }}" == "pull_request" ]]; then
                    npx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose
                  else
                    # For pushes, check the last commit
                    npx commitlint --from HEAD~1 --to HEAD --verbose
                  fi

            - name: Post helpful message on failure
              if: failure() && github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  script: |
                      // Check for existing commitlint error comment
                      const comments = await github.rest.issues.listComments({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo
                      });

                      const marker = '## ❌ Commit Message Format Error';
                      const existingComment = comments.data.find(comment =>
                        comment.body.includes(marker)
                      );

                      // Only post if no existing comment found
                      if (!existingComment) {
                        await github.rest.issues.createComment({
                          issue_number: context.issue.number,
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          body: `## ❌ Commit Message Format Error

                        Your commits don't follow the conventional commit format. Please use:

                        \`\`\`
                        type(scope): subject

                        [optional body]

                        [optional footer]
                        \`\`\`

                        **Valid types:** feat, fix, improve, perf, refactor, docs, style, test, build, ci, chore, revert
                        **Valid scopes:** admin, conditions, cookies, frontend, popup, theme, triggers, forms, extensions, integrations, accessibility, performance, ui, ux, build, deps, tests, api, core, docs, release, support
                        **Examples:**
                        - \`feat(triggers): add exit intent detection\`
                        - \`improve(popup): enhance animation speed options\`
                        - \`fix(forms): resolve Contact Form 7 tracking issue\`

                        See: https://www.conventionalcommits.org/`
                        });
                      }
